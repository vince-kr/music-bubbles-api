<!DOCTYPE html>
  <head>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="canvas_container">
      <canvas id="bubbles" width="2970" height="2100"></canvas>
    </div>
    <div id="inputs">
      <label for="title">Title: </label><input id="title"><br />
      <label for="tune">Tune: </label><input id="tune">
    </div>

    <script>
      // Canvas container size and dynamic resize
      const canvasContainer = document.getElementById("canvas_container");
      let canvasWidthRendered = Math.round(document.documentElement.clientWidth * 0.5);
      let canvasHeightRendered = Math.round(canvasWidthRendered * 0.70707);  // approximately
      canvasContainer.style.width = canvasWidthRendered + "px";
      canvasContainer.style.height = canvasHeightRendered + "px";

      window.addEventListener("resize", function() {
        let canvasWidth = Math.round(document.documentElement.clientWidth * 0.5);
        let canvasHeight = Math.round(canvasWidth * 0.70707);
        canvasContainer.style.width = canvasWidth + "px";
        canvasContainer.style.height = canvasHeight + "px";
      });

      // Canvas contents
      const bubblesCanvas = document.getElementById("bubbles");
      // Set canvas size (can be got from API at a later stage)
      bubblesCanvas.width = 1782
      bubblesCanvas.height = 1260

      const listOfNotes = document.getElementById("tune");
      listOfNotes.addEventListener("input", proctor);

      async function caller(tune) {
        try {
          let notes_array = await getBubbleNumbers(tune);
          console.log(notes_array);
          return notes_array;
        } catch (error) {
          console.error(error); // Handle any errors here
        }
      }

      function proctor(tune) {
        tune = listOfNotes.value
        // Call each required function in turn
        console.log('Calling validate')
        if (tune == null || !validateTune(tune)) {
          // Return the function
          return;
        };
        tune = tune.trim().replace(/ /g, "-")
        console.log('Calling getBubbleNumbers (which calls API)')
        let notes_array = caller(tune);
        console.log('Calling drawBubbles')
        drawBubbles(notes_array);
      };

      function validateTitle(title) {
        // Make sure the title only contains alphanumeric characters
        // This should also be safely checked in the backend
        const lettersNumbersSpacesRegex = /^[0-9a-zA-Z\s]+$/;
        return lettersNumbersSpacesRegex.test(title);
      }

      function validateTune(tune) {
        // Make sure tune only contains valid note names (a - g)
        // This should also be safely checked in the backend
        const noteNamesRegex = /^[abcdefgr\s]+$/;
        return noteNamesRegex.test(tune);
      };

async function getBubbleNumbers(tune) {
  if (!tune) {
    return [];
  }
  
  try {
    var address = 'http://127.0.0.1:50505/canvas_coordinates?notes_list=' + tune;
    const response = await fetch(address, {
      method: "GET",
      headers: {
        "Origin": "http://127.0.0.1"
      }
    });
    const data = await response.json();
    return data;
  } catch (error) {
    console.error(error);
    return []; // Return an empty array or handle the error case as per your requirement
  }
}


      function drawBubbles(notes_array) {
        // Access the canvas and draw circles according to coordinates
        console.log("drawBubbles function")
      };

      // Some manual note drawing to get an idea
      const bubblesContext = bubblesCanvas.getContext("2d");
      bubblesContext.fillStyle = "red";
      bubblesContext.beginPath();
      bubblesContext.arc(360, 630, 120, 0, 2*Math.PI);
      bubblesContext.fill();
    </script>
  </body>
</html>